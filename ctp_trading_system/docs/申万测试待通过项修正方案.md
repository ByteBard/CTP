# 申万测试待通过项修正方案

来源: `C:\baidunetdiskdownload\temp\待通过项 - 申万-mltrader.docx`
日期: 2026-01-27
状态: 待修正

---

## 问题总览

8个测试点未通过，全部是**截图证据类型不对**，不是功能缺失。

| 测试点 | 严重级别 | 问题类型 | 状态 |
|--------|---------|---------|------|
| 6 | 严重 | 断网方式错误 | 待修正 |
| 7 | 严重 | 依赖测试点6 | 待修正 |
| 8、9 | 严重 | 截图内容错误 | 待修正 |
| 10、11、12 | 选测 | 截图内容错误 | 可跳过 |
| 16 | 严重 | 混淆撤单类型 | 待修正 |
| 22、23、24 | 混合 | 错误来源错误 | 待修正 |
| 30 | 严重 | 日志内容不足 | 待修正 |
| 33 | 严重 | 日志内容不对 | 待修正 |

---

## 逐项修正方案

### 测试点6: 连接状态监测 - 断开连接

**原始问题**: 用"登出账号"模拟断开连接，不符合要求。要求通过断网或防火墙方式验证。

**修正方案**:
1. 使用Windows防火墙阻断CTP前置地址
   ```cmd
   # 添加防火墙规则阻断CTP交易前置
   netsh advfirewall firewall add rule name="Block_CTP" dir=out action=block remoteip=124.74.247.136
   ```
2. 等待系统检测到连接断开（OnFrontDisconnected回调触发）
3. Web UI应显示连接状态变为"断开"
4. 用Genesis截图，截图内容需包含:
   - 连接状态显示"断开"或"已断开连接"
   - 断开时间
5. 截图后恢复防火墙:
   ```cmd
   netsh advfirewall firewall delete rule name="Block_CTP"
   ```

**代码检查**: `ctp_trading_system/monitor/connection_monitor.py` 中的 `OnFrontDisconnected` 回调是否正确更新状态。

**关键**: 不能用logout，必须是物理层面的连接中断。

---

### 测试点7: 连接状态监测 - 重新连接

**原始问题**: 需要在测试点6断网基础上重新连接，需重新截图。

**修正方案**:
1. 在测试点6阻断连接后，删除防火墙规则恢复网络
   ```cmd
   netsh advfirewall firewall delete rule name="Block_CTP"
   ```
2. 等待系统自动重连（CTP API会自动尝试重连）
3. Web UI应显示连接状态恢复为"已连接"
4. 用Genesis截图，截图内容需包含:
   - 连接状态显示"已连接"或"重连成功"
   - 重连时间
   - 最好能看到从"断开"→"已连接"的状态变化记录

**代码检查**: `ctp_trading_system/monitor/connection_monitor.py` 中是否有自动重连逻辑和重连成功的日志。

**关键**: 必须是测试点6断网后的重连，不是重新启动程序。

---

### 测试点8、9: 报单笔数和撤单笔数记录

**原始问题**: 提供的是"重复报单/重复撤单触发阈值提醒"的截图，但要求的是**记录报单笔数和撤单笔数**的截图。

**区分**:
- 错误截图: "重复报单触发阈值! 已达5笔" (这是阈值告警)
- 正确截图: "当前报单总笔数: 150笔, 撤单总笔数: 30笔" (这是计数记录)

**修正方案**:
1. Web UI需要有一个区域**实时显示**:
   - 当前报单总笔数（累计）
   - 当前撤单总笔数（累计）
2. 这个计数应该在"监控面板"或"交易统计"页面可见
3. 用Genesis截图该页面

**代码检查**: `ctp_trading_system/monitor/order_monitor.py` 中:
- 是否有 `order_count` 和 `cancel_count` 的累计计数器
- Web API是否暴露了这些计数
- Web UI是否展示了这些计数

**可能需要修改**:
- 在Web UI的监控页面添加"报单笔数"和"撤单笔数"的实时显示
- 确保API端点 `/api/monitor/status` 或类似接口返回这些数据

---

### 测试点10、11、12: 重复开仓/平仓/撤单笔数记录 (选测)

**原始问题**: 同测试点8、9，提供的是触发阈值后的提醒截图，要的是笔数记录截图。

**修正方案**: 同测试点8、9，需要在Web UI展示:
- 重复开仓单笔数
- 重复平仓单笔数
- 重复撤单笔数

**注意**: 这是选测项，不支持不影响最终测试结果。如果时间紧迫可以跳过。

---

### 测试点16: 任意撤单笔数阈值提醒

**原始问题**: 混淆了"任意撤单"和"重复撤单"。提供的是重复撤单触发阈值的截图，要的是**任意撤单笔数**触发阈值的截图。

**区分**:
- 重复撤单: 同一合约同方向的撤单次数超过阈值
- 任意撤单: 所有撤单（不区分合约方向）的总笔数超过阈值

**修正方案**:
1. 确认系统有"任意撤单总笔数阈值"的监测功能
2. 设置一个较低的阈值（如10笔）方便触发
3. 进行多笔不同合约的撤单操作，使总撤单数超过阈值
4. 截图阈值触发后的提醒，提醒内容应为:
   - "任意撤单总笔数已达XX笔，超过阈值YY笔" (不是"重复撤单")

**代码检查**: `ctp_trading_system/monitor/order_monitor.py` 和 `ctp_trading_system/monitor/threshold_manager.py`:
- 是否区分了"任意撤单"和"重复撤单"两个独立的阈值
- 提醒文案是否清晰区分了两种类型

**可能需要修改**:
- 确保阈值提醒的文案明确标注是"任意撤单"而非"重复撤单"
- 如果只有"重复撤单"阈值，需要新增"任意撤单总笔数"阈值监测

---

### 测试点22、23、24: 柜台错误提示 (资金不足/持仓不足/市场状态错误)

**原始问题**: 提供的是**终端拦截**后的提示（前端validator拦截），要求的是**柜台/交易所返回的错误提示**。

**区分**:
- 错误截图: "前端校验: 资金不足，委托已拦截" (终端自己拦截了)
- 正确截图: "CTP返回: [ErrorID=51] 资金不足" (柜台返回的错误)

**修正方案**:
1. **关键: 让委托绕过前端校验，真正发送到CTP柜台**
2. 方法A: 临时禁用前端validator的资金/持仓/市场状态校验
3. 方法B: 添加"测试模式"开关，在测试模式下不做前端拦截
4. 构造触发条件:
   - 资金不足: 下大手数委托，超过账户可用资金
   - 持仓不足: 对没有持仓的合约发平仓指令
   - 市场状态错误: 在非交易时段发送委托
5. 截图CTP返回的错误信息，需包含:
   - CTP错误码 (ErrorID)
   - CTP错误信息 (ErrorMsg)
   - 显示在Web UI的日志或弹窗中

**代码检查**:
- `ctp_trading_system/validator/order_validator.py`: 前端校验逻辑，需要支持临时绕过
- `ctp_trading_system/core/ctp_gateway.py`: `OnRspOrderInsert` 和 `OnErrRtnOrderInsert` 回调是否正确处理柜台错误
- `ctp_trading_system/web/api/`: 是否有接口可以在"不校验"模式下发送委托

**可能需要修改**:
- 添加API参数 `skip_validation=true` 或 Web UI上的"跳过前端校验"开关
- 确保柜台返回的错误信息在Web UI上可见且可截图
- OnRspOrderInsert回调中的错误信息需要传递到前端显示

---

### 测试点30: 交易信息日志记录

**原始问题**: 提供的日志截图不符合要求，需要包含开仓/平仓/撤单的详细信息。

**修正方案**:
1. 日志需要包含至少一种交易操作的完整信息:
   - 开仓: 时间、合约、方向(买/卖)、开平(开仓)、价格、数量、委托状态
   - 平仓: 时间、合约、方向、开平(平仓)、价格、数量、委托状态
   - 撤单: 时间、合约、原委托编号、撤单状态
2. 日志格式示例:
   ```
   2026-01-27 10:30:15 [交易] 开仓委托: 合约=rb2505, 方向=买, 价格=3850, 数量=1, 委托编号=12345, 状态=已成交
   2026-01-27 10:35:20 [交易] 平仓委托: 合约=rb2505, 方向=卖, 价格=3860, 数量=1, 委托编号=12346, 状态=已成交
   ```
3. 用Genesis截图日志页面或日志文件

**代码检查**: `ctp_trading_system/trade_logging/trade_logger.py`:
- 日志是否记录了足够的交易详情
- Web UI是否有日志查看页面

**可能需要修改**:
- 确保trade_logger记录完整的委托字段
- Web UI日志页面需要展示这些详细信息

---

### 测试点33: 错误提示日志记录

**原始问题**: 提供的错误日志截图不符合"资金不足/持仓不足/市场状态错误"三种错误中的任何一种。

**修正方案**:
1. 需要在日志中记录CTP柜台返回的错误信息（与测试点22-24关联）
2. 日志格式示例:
   ```
   2026-01-27 14:30:00 [错误] CTP柜台返回: ErrorID=51, ErrorMsg=资金不足, 合约=rb2505, 方向=买, 数量=100
   ```
3. 先完成测试点22-24（让委托发到柜台被拒），然后截日志中的对应记录

**代码检查**:
- `ctp_trading_system/core/ctp_gateway.py`: OnRspOrderInsert回调是否将错误写入日志
- `ctp_trading_system/trade_logging/trade_logger.py`: 是否有专门的错误日志记录

**关键**: 这个测试点和22-24是联动的。22-24要截Web UI上的错误提示，33要截日志文件中的错误记录。

---

## 修正优先级

1. **P0 (必须修正)**:
   - 测试点6、7: 断网重连 → 用防火墙方式重新测试截图
   - 测试点8、9: 报单/撤单笔数 → Web UI添加计数显示
   - 测试点16: 任意撤单阈值 → 确认文案区分，重新截图
   - 测试点22、23、24: 柜台错误 → 添加绕过前端校验的功能
   - 测试点30: 交易日志 → 确保日志包含完整交易详情
   - 测试点33: 错误日志 → 与22-24联动

2. **P1 (可跳过)**:
   - 测试点10、11、12: 选测项，不影响最终结果

## 修正依赖关系

```
测试点6 → 测试点7 (必须先断网才能截重连)
测试点22/23/24 → 测试点33 (必须先有柜台错误才能截错误日志)
测试点8/9 → 可能需要代码修改 (Web UI添加计数显示)
测试点16 → 可能需要代码修改 (区分任意撤单vs重复撤单)
```

## 截图工具提醒

- 必须使用 Genesis 截图工具: `ctp_trading_system/docs/辅助截图工具/Genesis/Genesis.exe`
- 不能使用Windows自带截图或其他工具
- 测试完成后使用 Argus 生成电子证据
